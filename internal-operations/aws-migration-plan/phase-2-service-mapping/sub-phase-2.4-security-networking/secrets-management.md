# Secrets Management Design for MisterSmith AWS Migration

## Overview

This document defines the secrets management strategy for MisterSmith, using AWS Secrets Manager and Systems Manager Parameter Store, following CDK Nag rule ECS2 (no plaintext environment variables).

## Secrets Architecture

### Service Segregation

```
AWS Secrets Manager (for sensitive data):
├── Database Credentials
├── API Keys
├── JWT Secrets
├── OAuth Credentials
└── Encryption Keys

Parameter Store (for configuration):
├── Service URLs
├── Feature Flags
├── Non-sensitive Config
└── Environment Settings
```

## Secrets Manager Implementation

### 1. Database Credentials
**Secret Name**: `mistersmith/aurora/master`
```json
{
  "username": "mistersmith_admin",
  "password": "<auto-generated>",
  "engine": "postgres",
  "host": "mistersmith-aurora-cluster.cluster-xxxxx.us-east-1.rds.amazonaws.com",
  "port": 5432,
  "dbClusterIdentifier": "mistersmith-aurora-cluster"
}
```

**Rotation Configuration**:
- Rotation enabled: Yes
- Rotation schedule: Every 30 days
- Rotation Lambda: AWS managed for RDS

### 2. Application Secrets
**Secret Name**: `mistersmith/app/jwt`
```json
{
  "secret": "<256-bit-key>",
  "algorithm": "HS256",
  "issuer": "mistersmith",
  "expiry": "1h"
}
```

**Secret Name**: `mistersmith/app/encryption`
```json
{
  "masterKey": "<base64-encoded-key>",
  "algorithm": "AES-256-GCM",
  "keyDerivation": "PBKDF2"
}
```

### 3. External Service Credentials
**Secret Name**: `mistersmith/external/openai`
```json
{
  "apiKey": "<api-key>",
  "organizationId": "<org-id>",
  "projectId": "<project-id>"
}
```

**Secret Name**: `mistersmith/external/oauth/github`
```json
{
  "clientId": "<client-id>",
  "clientSecret": "<client-secret>",
  "redirectUri": "https://api.mistersmith.ai/auth/github/callback"
}
```

### 4. Message Queue Credentials
**Secret Name**: `mistersmith/amazonmq/credentials`
```json
{
  "username": "mistersmith_mq",
  "password": "<auto-generated>",
  "endpoints": {
    "amqps": "amqps://b-xxxxx.mq.us-east-1.amazonaws.com:5671",
    "wss": "wss://b-xxxxx.mq.us-east-1.amazonaws.com:61619"
  }
}
```

## Parameter Store Configuration

### Hierarchical Structure
```
/mistersmith/
├── /production/
│   ├── /config/
│   │   ├── api_base_url
│   │   ├── frontend_url
│   │   ├── allowed_origins
│   │   └── log_level
│   ├── /features/
│   │   ├── enable_new_ui
│   │   ├── max_agents_per_swarm
│   │   └── rate_limit_requests
│   └── /services/
│       ├── elasticsearch_endpoint
│       ├── redis_endpoint
│       └── s3_bucket_name
└── /staging/
    └── ... (mirror of production)
```

### Parameter Examples

**Parameter**: `/mistersmith/production/config/api_base_url`
- Type: String
- Value: `https://api.mistersmith.ai`
- Tier: Standard

**Parameter**: `/mistersmith/production/features/max_agents_per_swarm`
- Type: String
- Value: `10`
- Tier: Standard

## ECS Integration (CDK Nag ECS2 Compliance)

### Task Definition Secrets
```typescript
const taskDefinition = new FargateTaskDefinition(this, 'TaskDef', {
  memoryLimitMiB: 2048,
  cpu: 1024,
});

const container = taskDefinition.addContainer('app', {
  image: ContainerImage.fromEcrRepository(repository),
  environment: {
    // Only non-sensitive values
    NODE_ENV: 'production',
    SERVICE_NAME: 'mistersmith-api',
  },
  secrets: {
    // All sensitive values from Secrets Manager
    DATABASE_URL: Secret.fromSecretsManager(dbSecret, 'connectionString'),
    JWT_SECRET: Secret.fromSecretsManager(jwtSecret, 'secret'),
    OPENAI_API_KEY: Secret.fromSecretsManager(openaiSecret, 'apiKey'),
    // Configuration from Parameter Store
    API_BASE_URL: Secret.fromSsmParameter(
      StringParameter.fromStringParameterName(
        this, 'ApiUrl',
        '/mistersmith/production/config/api_base_url'
      )
    ),
  },
});
```

## Access Control

### Secret Resource Policies
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": [
          "arn:aws:iam::123456789012:role/MisterSmithEcsTaskRole",
          "arn:aws:iam::123456789012:role/MisterSmithEcsTaskExecutionRole"
        ]
      },
      "Action": "secretsmanager:GetSecretValue",
      "Resource": "*"
    },
    {
      "Effect": "Deny",
      "Principal": "*",
      "Action": "secretsmanager:DeleteSecret",
      "Resource": "*"
    }
  ]
}
```

## Rotation Strategy

### Automatic Rotation Schedule
| Secret Type | Rotation Period | Method |
|-------------|----------------|---------|
| Database passwords | 30 days | AWS Lambda (managed) |
| API keys | 90 days | Custom Lambda |
| JWT secrets | 180 days | Blue-green deployment |
| OAuth secrets | Manual | Via provider console |

### Custom Rotation Lambda
```python
def lambda_handler(event, context):
    """Custom rotation for API keys"""
    service_client = boto3.client('secretsmanager')
    
    if event['Step'] == 'createSecret':
        # Generate new API key
        new_key = generate_api_key()
        service_client.put_secret_value(
            SecretId=event['SecretId'],
            VersionId=event['Token'],
            SecretString=json.dumps({'apiKey': new_key})
        )
    
    elif event['Step'] == 'setSecret':
        # Update external service with new key
        update_external_service(new_key)
    
    elif event['Step'] == 'testSecret':
        # Verify new key works
        test_api_key(new_key)
    
    elif event['Step'] == 'finishSecret':
        # Mark new version as current
        service_client.update_secret_version_stage(
            SecretId=event['SecretId'],
            VersionId=event['Token'],
            MoveToVersionId=event['Token'],
            VersionStage='AWSCURRENT'
        )
```

## Encryption

### Secrets Manager Encryption
- KMS Key: `alias/mistersmith-secrets`
- Key Policy: Restrict to specific roles
- Automatic rotation: Enabled

### Parameter Store Encryption
- KMS Key: `alias/aws/ssm` (default)
- SecureString type for sensitive parameters

## Monitoring and Auditing

### CloudWatch Metrics
```yaml
Alarms:
  - SecretRotationFailed
  - SecretAccessDenied
  - UnauthorizedSecretAccess
  - SecretNearExpiry
```

### CloudTrail Events
```yaml
Monitored Events:
  - GetSecretValue
  - PutSecretValue
  - UpdateSecret
  - DeleteSecret
  - RotateSecret
```

### Access Patterns Dashboard
- Secret access frequency
- Access by service/role
- Failed access attempts
- Rotation success rate

## Disaster Recovery

### Backup Strategy
1. **Secrets Manager**: Automatic backups via AWS Backup
2. **Parameter Store**: CloudFormation/CDK state
3. **Cross-region replication**: Critical secrets only

### Recovery Procedures
1. **Secret Compromise**:
   - Immediate rotation
   - Audit trail review
   - Service credential update

2. **Region Failure**:
   - Failover to replica secrets
   - Update service configurations
   - Verify connectivity

## Development Workflow

### Local Development
```bash
# Use aws-vault for local credentials
aws-vault exec dev -- npm run dev

# Environment file for local dev (git-ignored)
DATABASE_URL=postgresql://localhost:5432/mistersmith_dev
JWT_SECRET=local-dev-secret-not-for-production
```

### CI/CD Integration
```yaml
# GitHub Actions example
- name: Configure AWS credentials
  uses: aws-actions/configure-aws-credentials@v2
  with:
    role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
    aws-region: us-east-1

- name: Deploy to ECS
  run: |
    # Secrets are injected by ECS, not in CI/CD
    aws ecs update-service \
      --cluster mistersmith-cluster \
      --service mistersmith-api \
      --force-new-deployment
```

## Cost Optimization

### Secrets Manager Costs
- $0.40 per secret per month
- $0.05 per 10,000 API calls
- Estimate: ~$10/month for 20 secrets

### Parameter Store Costs
- Standard parameters: Free (up to 10,000)
- Advanced parameters: $0.05 per parameter per month
- Estimate: $0 (using standard tier)

## CDK Nag Compliance

### No Suppressions Required
- ✅ ECS2: All environment variables use Secrets Manager
- ✅ No hardcoded credentials
- ✅ Proper IAM permissions
- ✅ Encryption at rest