<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisterSmith Discovery Stream</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #00ff00;
            text-align: center;
            text-shadow: 0 0 10px #00ff00;
        }
        
        .controls {
            margin: 20px 0;
            padding: 20px;
            background-color: #2a2a2a;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        
        input, button {
            font-family: inherit;
            padding: 8px 12px;
            margin: 5px;
            background-color: #1e1e1e;
            color: #00ff00;
            border: 1px solid #00ff00;
            border-radius: 3px;
        }
        
        button:hover {
            background-color: #00ff00;
            color: #1e1e1e;
            cursor: pointer;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            background-color: #2a2a2a;
            border-left: 3px solid #00ff00;
        }
        
        .discovery-log {
            margin-top: 20px;
            padding: 20px;
            background-color: #0a0a0a;
            border: 1px solid #00ff00;
            border-radius: 5px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .discovery-item {
            margin: 10px 0;
            padding: 10px;
            background-color: #1a1a1a;
            border-left: 3px solid;
            animation: fadeIn 0.5s;
        }
        
        .discovery-item.pattern { border-color: #00ffff; }
        .discovery-item.anomaly { border-color: #ff0066; }
        .discovery-item.connection { border-color: #ffff00; }
        .discovery-item.solution { border-color: #00ff00; }
        .discovery-item.question { border-color: #ff6600; }
        .discovery-item.insight { border-color: #9966ff; }
        
        .timestamp {
            color: #666;
            font-size: 0.8em;
        }
        
        .uri {
            color: #00ffff;
            word-break: break-all;
        }
        
        .error {
            color: #ff0066;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç MisterSmith Discovery Stream</h1>
        
        <div class="controls">
            <div>
                <label>Agent ID: </label>
                <input type="text" id="agentId" value="web-monitor-001" placeholder="Enter agent ID">
                <button id="connectBtn">Connect</button>
                <button id="disconnectBtn" disabled>Disconnect</button>
            </div>
            <div class="status" id="status">Status: Disconnected</div>
        </div>
        
        <div class="discovery-log" id="discoveryLog">
            <div style="color: #666; text-align: center;">
                No discoveries yet. Click Connect to start streaming.
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;
        const agentIdInput = document.getElementById('agentId');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const statusDiv = document.getElementById('status');
        const discoveryLog = document.getElementById('discoveryLog');
        
        function updateStatus(message, isError = false) {
            statusDiv.textContent = `Status: ${message}`;
            statusDiv.style.borderColor = isError ? '#ff0066' : '#00ff00';
        }
        
        function addDiscovery(uri, timestamp) {
            // Parse discovery type from URI
            const parts = uri.split('/');
            const discoveryInfo = parts[parts.length - 1];
            const typeMatch = discoveryInfo.match(/\d+-(\w+)-/);
            const type = typeMatch ? typeMatch[1].toLowerCase() : 'unknown';
            
            const item = document.createElement('div');
            item.className = `discovery-item ${type}`;
            item.innerHTML = `
                <div class="timestamp">${new Date(timestamp).toLocaleTimeString()}</div>
                <div class="uri">${uri}</div>
            `;
            
            // Insert at top of log
            if (discoveryLog.firstChild.textContent.includes('No discoveries yet')) {
                discoveryLog.innerHTML = '';
            }
            discoveryLog.insertBefore(item, discoveryLog.firstChild);
            
            // Limit to 100 items
            while (discoveryLog.children.length > 100) {
                discoveryLog.removeChild(discoveryLog.lastChild);
            }
        }
        
        function connect() {
            const agentId = agentIdInput.value.trim();
            if (!agentId) {
                updateStatus('Please enter an agent ID', true);
                return;
            }
            
            const url = `http://localhost:3000/discoveries/stream?agent_id=${encodeURIComponent(agentId)}`;
            
            try {
                eventSource = new EventSource(url);
                
                eventSource.onopen = () => {
                    updateStatus('Connected');
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    agentIdInput.disabled = true;
                };
                
                eventSource.addEventListener('connected', (event) => {
                    const data = JSON.parse(event.data);
                    updateStatus(`Connected as ${data.agent_id} (client: ${data.client_id})`);
                });
                
                eventSource.addEventListener('discovery', (event) => {
                    const notification = JSON.parse(event.data);
                    addDiscovery(notification.params.uri, new Date());
                });
                
                eventSource.onerror = (error) => {
                    console.error('SSE Error:', error);
                    updateStatus('Connection error - check if server is running', true);
                    disconnect();
                };
                
            } catch (error) {
                updateStatus(`Failed to connect: ${error.message}`, true);
            }
        }
        
        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            updateStatus('Disconnected');
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            agentIdInput.disabled = false;
        }
        
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        
        // Auto-connect on Enter key
        agentIdInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !connectBtn.disabled) {
                connect();
            }
        });
        
        // Clean up on page unload
        window.addEventListener('beforeunload', disconnect);
    </script>
</body>
</html>